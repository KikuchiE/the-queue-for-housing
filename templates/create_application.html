{% extends "base.html" %}
{% block content %}
{% load static %}

<div class="container mx-auto p-4 mt-10">
    <div class="bg-white p-4 rounded shadow">
        <h1 class="text-lg font-semibold mb-4">Operations by Applicant</h1>
        
        <!-- Navigation Buttons -->
        <div class="flex flex-wrap space-x-2 mb-4">
            <button class="nav-button bg-blue-500 text-white py-2 px-4 rounded" data-section="applicant-data">
                Applicant Data
            </button>
            <button class="nav-button bg-gray-200 text-gray-700 py-2 px-4 rounded" data-section="family-data">
                Family Members Information
            </button>
            <button class="nav-button bg-gray-200 text-gray-700 py-2 px-4 rounded" data-section="application-submission">
                Application Submission
            </button>
        </div>

        <form method="post" enctype="multipart/form-data" id="application-form">
            {% csrf_token %}
            
            <!-- Form Sections -->
            <div id="form-sections">
                <!-- Section 1: Applicant Data -->
                <div id="applicant-data" class="form-section active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="block text-gray-700 mb-2">Full Name</label>
                            <input
                                type="text"
                                class="w-full p-2 border rounded"
                                value="{{ user.first_name }} {{ user.last_name }}"
                                disabled
                            />
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-2">Условия текущего проживания</label>
                            {{ applicant_form.current_residence_condition }}
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-2">Ежемесячный доход</label>
                            {{ applicant_form.monthly_income }}
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-2">Площадь текущего жилья (м²)</label>
                            {{ applicant_form.current_living_area }}
                        </div>
                        <div class="form-group">
                            <label class="block text-gray-700 mb-2">Текущий адрес</label>
                            {{ applicant_form.current_address }}
                        </div>
                        <div class="form-group">
                            <label class="flex items-center">
                                {{ applicant_form.is_homeless }}
                                <span>Отсутствие постоянного жилья</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Family Data -->
                <div id="family-data" class="form-section hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="flex items-center">
                                {{ family_form.is_single_parent }}
                                <span>Родитель-одиночка</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="flex items-center">
                                {{ family_form.is_veteran }}
                                <span>Ветеран</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="flex items-center">
                                {{ family_form.has_disability }}
                                <span>Наличие инвалидности</span>
                            </label>
                        </div>
                        <div class="form-group" id="disability-document-group">
                            <label class="block text-gray-700 mb-2">
                                Документ об инвалидности
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="flex items-center">
                                {{ family_form.applicant_disability }}
                            </div>
                        </div>
                    </div>

                    <!-- Household Members Section -->
                    <div class="mt-6 border-t pt-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Family Members</h3>
                            <button id="add-member-button" type="button" class="bg-green-500 text-white py-2 px-4 rounded flex items-center">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5 mr-1"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Add Family Member
                            </button>
                        </div>

                        <!-- Household Members Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse" id="household-members-table">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border p-2 text-left">Full Name</th>
                                        <th class="border p-2 text-left">Date of Birth</th>
                                        <th class="border p-2 text-left">Relationship</th>
                                        <th class="border p-2 text-left">Disability</th>
                                        <th class="border p-2 text-left">Documents</th>
                                        <th class="border p-2 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="household-members-list">
                                    <tr class="text-center text-gray-500">
                                        <td colspan="6" class="border p-4">No family members added</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Application Submission -->
                <div id="application-submission" class="form-section hidden">
                    <div class="border p-4 rounded mb-4">
                        <h3 class="font-semibold mb-2">Application Overview</h3>
                        <p class="mb-2">
                            Application Number:
                            <span id="summary-application-number">-</span>
                        </p>
                        <p class="mb-2">
                            Status:
                            <span id="summary-status">-</span>
                        </p>
                        <p class="mb-2">
                            Priority Score:
                            <span id="summary-priority-score">-</span>
                        </p>
                        <p class="mb-2">
                            Queue Position:
                            <span id="summary-queue-position">-</span>
                        </p>
                    </div>

                    <div class="mb-4">
                        <h3 class="font-semibold mb-2">Change History</h3>
                        <table class="w-full border-collapse">
                            <thead>
                                <tr>
                                    <th class="border p-2 text-left">Date</th>
                                    <th class="border p-2 text-left">Previous Status</th>
                                    <th class="border p-2 text-left">New Status</th>
                                    <th class="border p-2 text-left">Modified By</th>
                                </tr>
                            </thead>
                            <tbody id="history-table">
                                <tr>
                                    <td colspan="4" class="border p-2 text-center">No change history</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Notes</label>
                        {{ submission_form.notes }}
                    </div>

                    <div class="form-group">
                        <label class="flex items-center">
                            {{ submission_form.confirm_submission }}
                            <span>I confirm that all provided information is accurate and complete</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-4">
                <button type="button" class="bg-gray-500 text-white py-2 px-4 rounded" id="cancel-button">Cancel</button>
                <div class="space-x-4">
                    <button type="button" class="bg-blue-500 text-white py-2 px-4 rounded" id="prev-button">Back</button>
                    <button type="button" class="bg-blue-500 text-white py-2 px-4 rounded" id="next-button">Next</button>
                    <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded hidden" id="submit-button">Submit Application</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Household Member Modal -->
<div id="member-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Добавить члена семьи</h3>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="member-form" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="member-id" value="" />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="block text-gray-700 mb-2">
                        ФИО
                        <span class="text-red-500">*</span>
                    </label>
                    {{ household_form.full_name }}
                </div>

                <div class="form-group">
                    <label class="block text-gray-700 mb-2">
                        Дата рождения
                        <span class="text-red-500">*</span>
                    </label>
                    {{ household_form.date_of_birth }}
                </div>

                <div class="form-group">
                    <label class="block text-gray-700 mb-2">
                        Отношение
                        <span class="text-red-500">*</span>
                    </label>
                    {{ household_form.relationship }}
                </div>

                <div class="form-group">
                    <label class="flex items-center">
                        {{ household_form.has_disability }}
                        <span>Имеет инвалидность</span>
                    </label>
                </div>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-medium mb-3">Документы</h4>

                <div class="space-y-4">
                    <!-- ID Document - Required for all -->
                    <div class="form-group">
                        <label class="block text-gray-700 mb-2">
                            Документ, удостоверяющий личность
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="flex items-center">
                            {{ household_form.document_id }}
                        </div>
                    </div>

                    <!-- Birth Certificate - Required for children -->
                    <div class="form-group" id="birth-certificate-group">
                        <label class="block text-gray-700 mb-2">Свидетельство о рождении</label>
                        <div class="flex items-center">
                            {{ household_form.document_birth }}
                        </div>
                    </div>

                    <!-- Disability Certificate - Only shown if disability is checked -->
                    <div class="form-group hidden" id="disability-document-group">
                        <label class="block text-gray-700 mb-2">
                            Документ об инвалидности
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="flex items-center">
                            {{ household_form.document_disability }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" id="cancel-member" class="bg-gray-300 text-gray-800 py-2 px-4 rounded">Отмена</button>
                <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<script src="{% static 'js/application_better.js' %}"></script>
{% endblock %}