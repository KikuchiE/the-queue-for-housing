{% extends "base.html" %} {% block content %}
<div class="container mx-auto p-4 mt-10">
	<div class="bg-white p-4 rounded shadow">
		<h1 class="text-lg font-semibold mb-4">Operations by Applicant</h1>
		<!-- Navigation Buttons -->
		<div class="flex flex-wrap space-x-2 mb-4">
			<button class="nav-button bg-blue-500 text-white py-2 px-4 rounded" data-section="applicant-data">
				Applicant Data
			</button>
			<button class="nav-button bg-gray-200 text-gray-700 py-2 px-4 rounded" data-section="family-data">
				Family Members Information
			</button>
			<button class="nav-button bg-gray-200 text-gray-700 py-2 px-4 rounded" data-section="application-submission">
				Application Submission
			</button>
		</div>

		<!-- Form Sections -->
		<div id="form-sections">
			<!-- Section 1: Applicant Data -->
			<div id="applicant-data" class="form-section active">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
					<div class="form-group">
						<label class="block text-gray-700 mb-2">Full Name</label>
						<input type="text" class="w-full p-2 border rounded" value="{{ user.first_name }} {{ user.last_name }}" name="full_name" disabled/>
					</div>
					<div class="form-group">
						<label class="block text-gray-700 mb-2">Условия текущего проживания</label>
						<select class="w-full p-2 border rounded" name="current_residence_condition">
							<option value="GOOD">Хорошие</option>
							<option value="ADEQUATE">Удовлетворительные</option>
							<option value="POOR">Плохие</option>
							<option value="UNSAFE">Небезопасные</option>
						</select>
					</div>
					<div class="form-group">
						<label class="block text-gray-700 mb-2">Ежемесячный доход</label>
						<input type="number" class="w-full p-2 border rounded" name="monthly_income" step="0.01" />
					</div>
					<div class="form-group">
						<label class="block text-gray-700 mb-2">Площадь текущего жилья (м²)</label>
						<input type="number" class="w-full p-2 border rounded" name="current_living_area" step="0.01" />
					</div>
					<div class="form-group">
						<label class="block text-gray-700 mb-2">Текущий адрес</label>
						<textarea class="w-full p-2 border rounded" name="current_address" rows="3"></textarea>
					</div>
					<div class="form-group">
						<label class="flex items-center">
							<input type="checkbox" name="is_homeless" class="mr-2" />
							<span>Отсутствие постоянного жилья</span>
						</label>
					</div>
				</div>
			</div>

			<!-- Section 2: Family Data -->
			<div id="family-data" class="form-section hidden">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
					<div class="form-group">
						<label class="flex items-center">
							<input type="checkbox" name="is_single_parent" class="mr-2" />
							<span>Родитель-одиночка</span>
						</label>
					</div>
					<div class="form-group">
						<label class="flex items-center">
							<input type="checkbox" name="is_veteran" class="mr-2" />
							<span>Ветеран</span>
						</label>
					</div>
					<div class="form-group">
						<label class="flex items-center">
							<input type="checkbox" name="has_disability" class="mr-2" />
							<span>Наличие инвалидности</span>
						</label>
					</div>
					<div class="form-group">
						<label class="block text-gray-700 mb-2">Подробности инвалидности</label>
						<textarea class="w-full p-2 border rounded" name="disability_details" rows="3"></textarea>
					</div>
				</div>

				<!-- Household Members Section -->
				<div class="mt-6 border-t pt-4">
					<div class="flex justify-between items-center mb-4">
						<h3 class="text-lg font-semibold">Члены семьи</h3>
						<button id="add-member-button" class="bg-green-500 text-white py-2 px-4 rounded flex items-center">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
							</svg>
							Добавить члена семьи
						</button>
					</div>

					<!-- Household Members Table -->
					<div class="overflow-x-auto">
						<table class="w-full border-collapse" id="household-members-table">
							<thead>
								<tr class="bg-gray-100">
									<th class="border p-2 text-left">ФИО</th>
									<th class="border p-2 text-left">Дата рождения</th>
									<th class="border p-2 text-left">Отношение</th>
									<th class="border p-2 text-left">Инвалидность</th>
									<th class="border p-2 text-left">Документы</th>
									<th class="border p-2 text-left">Действия</th>
								</tr>
							</thead>
							<tbody id="household-members-list">
								<tr class="text-center text-gray-500">
									<td colspan="6" class="border p-4">Нет добавленных членов семьи</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Section 3: Application Submission -->
			<div id="application-submission" class="form-section hidden">
				<div class="border p-4 rounded mb-4">
					<h3 class="font-semibold mb-2">Обзор заявления</h3>
					<p class="mb-2">
						Номер заявления:
						<span id="summary-application-number">-</span>
					</p>
					<p class="mb-2">
						Статус:
						<span id="summary-status">-</span>
					</p>
					<p class="mb-2">
						Приоритетный балл:
						<span id="summary-priority-score">-</span>
					</p>
					<p class="mb-2">
						Позиция в очереди:
						<span id="summary-queue-position">-</span>
					</p>
				</div>

				<div class="mb-4">
					<h3 class="font-semibold mb-2">История изменений</h3>
					<table class="w-full border-collapse">
						<thead>
							<tr>
								<th class="border p-2 text-left">Дата</th>
								<th class="border p-2 text-left">Предыдущий статус</th>
								<th class="border p-2 text-left">Новый статус</th>
								<th class="border p-2 text-left">Кем изменено</th>
							</tr>
						</thead>
						<tbody id="history-table">
							<tr>
								<td colspan="4" class="border p-2 text-center">Нет истории изменений</td>
							</tr>
						</tbody>
					</table>
				</div>

				<div class="mb-4">
					<label class="block text-gray-700 mb-2">Примечания</label>
					<textarea class="w-full p-2 border rounded" name="notes" rows="3"></textarea>
				</div>

				<div class="form-group">
					<label class="flex items-center">
						<input type="checkbox" name="confirm_submission" class="mr-2" />
						<span>Я подтверждаю, что вся предоставленная информация является верной и полной</span>
					</label>
				</div>
			</div>
		</div>

		<!-- Navigation Buttons -->
		<div class="flex justify-between mt-4">
			<button class="bg-gray-500 text-white py-2 px-4 rounded" id="cancel-button">Cancel</button>
			<div class="space-x-4">
				<button class="bg-blue-500 text-white py-2 px-4 rounded" id="prev-button">Back</button>
				<button class="bg-blue-500 text-white py-2 px-4 rounded" id="next-button">Next</button>
			</div>
		</div>
	</div>
</div>

<!-- Household Member Modal -->
<div id="member-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
	<div class="bg-white rounded-lg p-6 w-full max-w-2xl">
		<div class="flex justify-between items-center mb-4">
			<h3 class="text-lg font-semibold">Добавить члена семьи</h3>
			<button id="close-modal" class="text-gray-500 hover:text-gray-700">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
				</svg>
			</button>
		</div>

		<form id="member-form" class="space-y-4">
			<input type="hidden" id="member-id" value="">
			
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div class="form-group">
					<label class="block text-gray-700 mb-2">ФИО <span class="text-red-500">*</span></label>
					<input type="text" id="member-name" class="w-full p-2 border rounded" required>
				</div>
				
				<div class="form-group">
					<label class="block text-gray-700 mb-2">Дата рождения <span class="text-red-500">*</span></label>
					<input type="date" id="member-birthdate" class="w-full p-2 border rounded" required>
				</div>
				
				<div class="form-group">
					<label class="block text-gray-700 mb-2">Отношение <span class="text-red-500">*</span></label>
					<select id="member-relationship" class="w-full p-2 border rounded" required>
						<option value="">Выберите...</option>
						<option value="SPOUSE">Супруг(а)</option>
						<option value="CHILD">Ребенок</option>
						<option value="PARENT">Родитель</option>
						<option value="SIBLING">Брат/Сестра</option>
						<option value="OTHER">Другое</option>
					</select>
				</div>
				
				<div class="form-group">
					<label class="flex items-center">
						<input type="checkbox" id="member-disability" class="mr-2">
						<span>Имеет инвалидность</span>
					</label>
				</div>
			</div>
			
			<div class="border-t pt-4">
				<h4 class="font-medium mb-3">Документы</h4>
				
				<div class="space-y-4">
					<!-- ID Document - Required for all -->
					<div class="form-group">
						<label class="block text-gray-700 mb-2">Документ, удостоверяющий личность <span class="text-red-500">*</span></label>
						<div class="flex items-center">
							<input type="file" id="document-id" class="p-2 border rounded w-full" required>
						</div>
					</div>
					
					<!-- Birth Certificate - Required for children -->
					<div class="form-group" id="birth-certificate-group">
						<label class="block text-gray-700 mb-2">Свидетельство о рождении</label>
						<div class="flex items-center">
							<input type="file" id="document-birth" class="p-2 border rounded w-full">
						</div>
					</div>
					
					<!-- Disability Certificate - Only shown if disability is checked -->
					<div class="form-group hidden" id="disability-document-group">
						<label class="block text-gray-700 mb-2">Документ об инвалидности <span class="text-red-500">*</span></label>
						<div class="flex items-center">
							<input type="file" id="document-disability" class="p-2 border rounded w-full">
						</div>
					</div>
				</div>
			</div>
			
			<div class="flex justify-end space-x-3 pt-4 border-t">
				<button type="button" id="cancel-member" class="bg-gray-300 text-gray-800 py-2 px-4 rounded">Отмена</button>
				<button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded">Сохранить</button>
			</div>
		</form>
	</div>
</div>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		const sections = [
			"applicant-data",
			"family-data",
			"application-submission",
		];
		let currentSectionIndex = 0;
		let householdMembers = [];
		let memberIdCounter = 1;

		// Function to show the current section
		function showCurrentSection() {
			// Hide all sections
			document.querySelectorAll(".form-section").forEach((section) => {
				section.classList.add("hidden");
			});

			// Show the current section
			document.getElementById(sections[currentSectionIndex]).classList.remove("hidden");

			// Update navigation buttons
			document.querySelectorAll(".nav-button").forEach((button) => {
				button.classList.remove("bg-blue-500", "text-white");
				button.classList.add("bg-gray-200", "text-gray-700");
			});

			const activeButton = document.querySelector(`.nav-button[data-section="${sections[currentSectionIndex]}"]`);
			if (activeButton) {
				activeButton.classList.remove("bg-gray-200", "text-gray-700");
				activeButton.classList.add("bg-blue-500", "text-white");
			}

			// Update prev/next buttons
			document.getElementById("prev-button").disabled = currentSectionIndex === 0;
			document.getElementById("prev-button").style.opacity = currentSectionIndex === 0 ? "0.5" : "1";

			// Update next button text on last section
			const nextButton = document.getElementById("next-button");
			if (currentSectionIndex === sections.length - 1) {
				nextButton.textContent = "Отправить";
			} else {
				nextButton.textContent = "Далее";
			}
		}

		// Initialize section navigation buttons
		document.querySelectorAll(".nav-button").forEach((button) => {
			button.addEventListener("click", function () {
				const sectionId = this.getAttribute("data-section");
				currentSectionIndex = sections.indexOf(sectionId);
				showCurrentSection();
			});
		});

		// Next button click handler
		document.getElementById("next-button").addEventListener("click", function () {
			if (currentSectionIndex < sections.length - 1) {
				currentSectionIndex++;
				showCurrentSection();
			} else {
				// This is the last section, handle form submission
				handleFormSubmission();
			}
		});

		// Previous button click handler
		document.getElementById("prev-button").addEventListener("click", function () {
			if (currentSectionIndex > 0) {
				currentSectionIndex--;
				showCurrentSection();
			}
		});

		// Handle cancel button
		document.getElementById("cancel-button").addEventListener("click", function () {
			if (confirm("Вы уверены, что хотите отменить? Все несохраненные данные будут потеряны.")) {
				window.location.href = "/"; // Redirect to home page
			}
		});

		// Toggle disability details based on checkbox
		const disabilityCheckbox = document.querySelector('input[name="has_disability"]');
		const disabilityDetails = document.querySelector('textarea[name="disability_details"]');

		if (disabilityCheckbox && disabilityDetails) {
			disabilityCheckbox.addEventListener("change", function () {
				const detailsGroup = disabilityDetails.closest(".form-group");
				if (this.checked) {
					detailsGroup.classList.remove("hidden");
				} else {
					detailsGroup.classList.add("hidden");
					disabilityDetails.value = "";
				}
			});

			// Initialize on page load
			if (!disabilityCheckbox.checked) {
				disabilityDetails.closest(".form-group").classList.add("hidden");
			}
		}

		// Function to update application summary
		function updateApplicationSummary() {
			const status = "-"; // Default
			const priorityScore = "-"; // Default
			const queuePosition = "-"; // Default

			document.getElementById("summary-status").textContent = status;
			document.getElementById("summary-priority-score").textContent = priorityScore;
			document.getElementById("summary-queue-position").textContent = queuePosition;
		}

		// Update summary when navigating to the summary page
		document
			.querySelector(`.nav-button[data-section="application-submission"]`)
			.addEventListener("click", updateApplicationSummary);

		// Handle form submission (placeholder)
		function handleFormSubmission() {
			const confirmCheckbox = document.querySelector('[name="confirm_submission"]');

			if (!confirmCheckbox.checked) {
				alert("Пожалуйста, подтвердите, что вся информация верна и полна.");
				return;
			}

			// Here you would typically submit the form data via AJAX
			alert("Форма успешно отправлена!");
			// For demonstration purposes only:
			// window.location.href = '/application-confirmation/';
		}

		// Function to handle showing/hiding dependent fields
		function setupDependentFields() {
			// Example: toggle homelessness details
			const homelessCheckbox = document.querySelector('[name="is_homeless"]');
			const addressField = document.querySelector('[name="current_address"]');

			if (homelessCheckbox && addressField) {
				homelessCheckbox.addEventListener("change", function () {
					const addressGroup = addressField.closest(".form-group");
					const livingAreaField = document.querySelector('[name="current_living_area"]');
					const livingAreaGroup = livingAreaField?.closest(".form-group");

					if (this.checked) {
						addressField.value = "Без определенного места жительства";
						addressField.readOnly = true;

						if (livingAreaField) {
							livingAreaField.value = "0";
							livingAreaGroup.classList.add("opacity-50");
							livingAreaField.readOnly = true;
						}
					} else {
						addressField.value = "";
						addressField.readOnly = false;

						if (livingAreaField) {
							livingAreaField.value = "";
							livingAreaGroup.classList.remove("opacity-50");
							livingAreaField.readOnly = false;
						}
					}
				});
			}
		}

		// Household Member Modal Functions
		const modal = document.getElementById("member-modal");
		const addMemberBtn = document.getElementById("add-member-button");
		const closeModalBtn = document.getElementById("close-modal");
		const cancelMemberBtn = document.getElementById("cancel-member");
		const memberForm = document.getElementById("member-form");
		const memberDisability = document.getElementById("member-disability");
		const disabilityDocGroup = document.getElementById("disability-document-group");
		const birthCertificateGroup = document.getElementById("birth-certificate-group");
		const memberRelationship = document.getElementById("member-relationship");
		
		// Show modal when add member button is clicked
		addMemberBtn.addEventListener("click", function() {
			modal.classList.remove("hidden");
			document.getElementById("member-id").value = ""; // Clear ID for new member
			memberForm.reset();
			updateDisabilityDocVisibility();
			updateBirthCertificateVisibility();
		});
		
		// Close modal
		function closeModal() {
			modal.classList.add("hidden");
		}
		
		closeModalBtn.addEventListener("click", closeModal);
		cancelMemberBtn.addEventListener("click", closeModal);
		
		// Close modal if clicked outside the content
		modal.addEventListener("click", function(e) {
			if (e.target === modal) {
				closeModal();
			}
		});
		
		// Toggle disability document visibility based on checkbox
		memberDisability.addEventListener("change", updateDisabilityDocVisibility);
		
		function updateDisabilityDocVisibility() {
			if (memberDisability.checked) {
				disabilityDocGroup.classList.remove("hidden");
				document.getElementById("document-disability").required = true;
			} else {
				disabilityDocGroup.classList.add("hidden");
				document.getElementById("document-disability").required = false;
			}
		}
		
		// Toggle birth certificate visibility based on relationship
		memberRelationship.addEventListener("change", updateBirthCertificateVisibility);
		
		function updateBirthCertificateVisibility() {
			if (memberRelationship.value === "CHILD") {
				birthCertificateGroup.classList.remove("hidden");
				document.getElementById("document-birth").required = true;
			} else {
				birthCertificateGroup.classList.add("hidden");
				document.getElementById("document-birth").required = false;
			}
		}
		
		// Handle member form submission
		memberForm.addEventListener("submit", function(e) {
			e.preventDefault();
			
			const memberId = document.getElementById("member-id").value || memberIdCounter++;
			const name = document.getElementById("member-name").value;
			const birthdate = document.getElementById("member-birthdate").value;
			const relationship = document.getElementById("member-relationship").value;
			const hasDisability = document.getElementById("member-disability").checked;
			
			// Get relationship display text
			const relationshipText = memberRelationship.options[memberRelationship.selectedIndex].text;
			
			// Document information (in a real application, you would upload these files)
			const idDoc = document.getElementById("document-id").value ? "✓" : "✗";
			const birthDoc = document.getElementById("document-birth").value ? "✓" : "—";
			const disabilityDoc = hasDisability ? (document.getElementById("document-disability").value ? "✓" : "✗") : "—";
			
			// Prepare member data
			const memberData = {
				id: memberId,
				name: name,
				birthdate: birthdate,
				relationship: relationship,
				relationshipText: relationshipText,
				hasDisability: hasDisability,
				documents: {
					id: idDoc,
					birth: birthDoc,
					disability: disabilityDoc
				}
			};
			
			// Check if editing existing member or adding new one
			const existingIndex = householdMembers.findIndex(m => m.id == memberId);
			if (existingIndex >= 0) {
				householdMembers[existingIndex] = memberData;
			} else {
				householdMembers.push(memberData);
			}
			
			// Update the table display
			updateMembersTable();
			
			// Close the modal
			closeModal();
		});
		
		// Function to update the members table
		function updateMembersTable() {
			const tableBody = document.getElementById("household-members-list");
			
			// Clear current table
			tableBody.innerHTML = "";
			
			if (householdMembers.length === 0) {
				tableBody.innerHTML = `
					<tr class="text-center text-gray-500">
						<td colspan="6" class="border p-4">Нет добавленных членов семьи</td>
					</tr>
				`;
				return;
			}
			
			// Add each member to the table
			householdMembers.forEach(member => {
				const row = document.createElement("tr");
				
				row.innerHTML = `
					<td class="border p-2">${member.name}</td>
					<td class="border p-2">${formatDate(member.birthdate)}</td>
					<td class="border p-2">${member.relationshipText}</td>
					<td class="border p-2">${member.hasDisability ? "Да" : "Нет"}</td>
					<td class="border p-2">
						<div>ID: ${member.documents.id}</div>
						${member.relationship === "CHILD" ? `<div>Birth: ${member.documents.birth}</div>` : ""}
						${member.hasDisability ? `<div>Disability: ${member.documents.disability}</div>` : ""}
					</td>
					<td class="border p-2">
						<div class="flex space-x-2">
							<button class="edit-member text-blue-500 hover:text-blue-700" data-id="${member.id}">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
								</svg>
							</button>
							<button class="delete-member text-red-500 hover:text-red-700" data-id="${member.id}">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
								</svg>
							</button>
						</div>
					</td>
				`;
				
				tableBody.appendChild(row);
			});
			
			// Add event listeners for edit and delete buttons
			document.querySelectorAll(".edit-member").forEach(button => {
				button.addEventListener("click", function() {
					const memberId = this.getAttribute("data-id");
					editMember(memberId);
				});
			});
			
			document.querySelectorAll(".delete-member").forEach(button => {
				button.addEventListener("click", function() {
					const memberId = this.getAttribute("data-id");
					deleteMember(memberId);
				});
			});
		}
		
		// Function to format date for display
		function formatDate(dateString) {
			const date = new Date(dateString);
			return date.toLocaleDateString();
		}
		
		// Function to edit a member
		function editMember(memberId) {
			const member = householdMembers.find(m => m.id == memberId);
			if (!member) return;
			
			// Fill form with member data
			document.getElementById("member-id").value = member.id;
			document.getElementById("member-name").value = member.name;
			document.getElementById("member-birthdate").value = member.birthdate;
			document.getElementById("member-relationship").value = member.relationship;
			document.getElementById("member-disability").checked = member.hasDisability;
			
			// Update visibility of document fields
			updateDisabilityDocVisibility();
			updateBirthCertificateVisibility();
			
			// Open modal
			modal.classList.remove("hidden");
		}
		
		// Function to delete a member
		function deleteMember(memberId) {
			if (confirm("Вы уверены, что хотите удалить этого члена семьи?")) {
				householdMembers = householdMembers.filter(m => m.id != memberId);
				updateMembersTable();
			}
		}

		setupDependentFields();
		showCurrentSection(); // Initialize the first section
	});
</script>

{% endblock %}